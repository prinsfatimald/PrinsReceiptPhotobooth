<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Receipt Photobooth</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Libre+Barcode+128+Text&display=swap" rel="stylesheet">

  <style>
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'VT323', monospace;
      background-color: black;
      color: white;
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      transition: background-color 0.5s, color 0.5s;
    }

    body.active-mode {
      background-color: white;
      color: black;
    }

    #screensaver {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      animation: float 4s infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-20px); }
    }

    .button {
      margin-top: 20px;
      padding: 10px 20px;
      background-color: white;
      color: black;
      font-size: 24px;
      border: none;
      cursor: pointer;
      font-family: 'VT323', monospace;
    }

    #hiddenBtn {
      position: absolute;
      bottom: 10px;
      left: 10px;
      opacity: 0;
    }

    .photobooth-container {
      display: none;
      flex-direction: row;
      align-items: center;
      gap: 20px;
    }

    .column {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .photo {
      width: 310px;
      height: 230px;
    }

    video {
      width: 960px;
      height: 720px;
      border: 3px solid white;
    }

    .controls {
      margin-top: 20px;
      text-align: center;
      font-size: 24px;
    }

    #codeInputPopup {
      position: absolute;
      top: 30%;
      left: 50%;
      transform: translateX(-50%);
      background: #222;
      padding: 20px;
      border-radius: 10px;
      display: none;
      color: white;
    }

    #photoStrip {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      text-align: center;
    }

    #choices, #stripPreview {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
    }

    .chosen {
      border: 3px solid blue;
    }

    .title-barcode {
      font-family: 'Libre Barcode 128 Text', cursive;
      font-size: 100px;
      margin-top: 20px;
    }

    #countdown {
      display: none;
      font-size: 24px;
      margin-top: 20px;
    }

    #prp {
      width: 500px;
      height: auto;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>

  <!-- Screensaver -->
  <div id="screensaver">
    <h1 class="title-barcode">Receipt Photobooth</h1>
    <p>Designed & Programmed by: Prins Dimasangkay</p>
    <img src="prp.png" alt="" id="prp">
    <button class="button" id="startBtn">START</button>
  </div>

  <!-- Hidden Developer Button -->
  <button id="hiddenBtn" onclick="printCodes()">Print Codes</button>

  <!-- Code Entry Popup -->
  <div id="codeInputPopup">
    <label for="codeInput">Enter Code to Start:</label><br/>
    <input type="text" id="codeInput" placeholder="Enter code"><br/><br/>
    <button class="button" id="confirmBtn">Confirm</button>
  </div>

  <!-- Countdown -->
  <div class="controls" id="countdown">Timer: 0s | Shot: 0/6</div>

  <!-- Camera Area -->
  <div class="photobooth-container" id="cameraSection">
    <div class="column">
      <img class="photo" id="shot1" />
      <img class="photo" id="shot2" />
      <img class="photo" id="shot3" />
    </div>
    <video id="video" autoplay></video>
    <div class="column">
      <img class="photo" id="shot4" />
      <img class="photo" id="shot5" />
      <img class="photo" id="shot6" />
    </div>
  </div>

  <!-- Photo Selection -->
  <div id="photoStrip">
    <h2>Choose 4 Photos to Print</h2>
    <div id="choices"></div>
    <div id="stripPreview"></div>
    <button class="button" id="printBtn">Print Strip</button>
  </div>

  <!-- Hidden Canvas -->
  <canvas id="canvas" style="display:none;"></canvas>

  <script>
    const startBtn = document.getElementById('startBtn');
    const confirmBtn = document.getElementById('confirmBtn');
    const hiddenBtn = document.getElementById('hiddenBtn');
    const codePopup = document.getElementById('codeInputPopup');
    const codeInput = document.getElementById('codeInput');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const cameraSection = document.getElementById('cameraSection');
    const countdown = document.getElementById('countdown');
    const photoStrip = document.getElementById('photoStrip');
    const choices = document.getElementById('choices');
    const stripPreview = document.getElementById('stripPreview');
    const printBtn = document.getElementById('printBtn');

    const shots = Array.from({ length: 6 }, (_, i) => document.getElementById(`shot${i + 1}`));
    const validCodes = ['PRINS', 'TIMS'];

    while (validCodes.length < 20) {
      validCodes.push(Math.random().toString(36).substring(2, 8).toUpperCase());
    }

    let capturedPhotos = [];
    let chosenPhotos = [];
    let currentShot = 0;

    document.addEventListener('keydown', e => {
      if (e.key.toLowerCase() === 'd') hiddenBtn.style.opacity = '1';
    });

    startBtn.addEventListener('click', () => {
      document.getElementById('screensaver').style.display = 'none';
      codePopup.style.display = 'block';
    });

    confirmBtn.addEventListener('click', async () => {
      const input = codeInput.value.trim().toUpperCase();
      if (validCodes.includes(input)) {
        document.body.classList.add('active-mode');
        codePopup.style.display = 'none';
        cameraSection.style.display = 'flex';
        await startCamera();
        startPhotoSequence();
        countdown.style.display = 'block';
      } else {
        alert('Invalid Code!');
      }
    });

    async function startCamera() {
      const stream = await navigator.mediaDevices.getUserMedia({ video: true });
      video.srcObject = stream;
    }

    function startPhotoSequence() {
      currentShot = 0;
      let timer = 5;

      const interval = setInterval(() => {
        countdown.textContent = `Timer: ${timer}s | Shot: ${currentShot}/6`;
        timer--;

        if (timer < 0) {
          takePhoto();
          currentShot++;
          timer = 5;
        }

        if (currentShot >= 6) {
          clearInterval(interval);
          endPhotoSession();
        }
      }, 1000);
    }

    function takePhoto() {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0);
      const dataUrl = canvas.toDataURL('image/png');

      if (shots[currentShot]) shots[currentShot].src = dataUrl;

      const img = new Image();
      img.src = dataUrl;
      capturedPhotos.push(img);
    }

    function endPhotoSession() {
      countdown.textContent = 'Done!';
      video.srcObject.getTracks().forEach(track => track.stop());
      cameraSection.style.display = 'none';
      photoStrip.style.display = 'flex';

      capturedPhotos.forEach(photo => {
        const clone = photo.cloneNode();
        clone.classList.add('photo');
        clone.addEventListener('click', () => {
          if (chosenPhotos.includes(clone)) {
            chosenPhotos = chosenPhotos.filter(p => p !== clone);
            clone.classList.remove('chosen');
          } else if (chosenPhotos.length < 4) {
            chosenPhotos.push(clone);
            clone.classList.add('chosen');
          }
          updateStripPreview();
        });
        choices.appendChild(clone);
      });
    }

    function updateStripPreview() {
      stripPreview.innerHTML = '';
      chosenPhotos.forEach(photo => {
        const clone = photo.cloneNode();
        clone.classList.remove('chosen');
        stripPreview.appendChild(clone);
      });
    }

    printBtn.addEventListener('click', () => {
      const printWindow = window.open('', '_blank');
      const styles = `
        <style>
          body { text-align: center; font-family: 'VT323', monospace; margin: 0; }
          img { width: 100%; max-width: 240px; margin: 5px auto; display: block; }
        </style>`;
      const content = chosenPhotos.map(photo => `<img src="${photo.src}" />`).join('');
      printWindow.document.write(`<html><head>${styles}</head><body>${content}</body></html>`);
      printWindow.document.close();
      printWindow.print();
      setTimeout(() => location.reload(), 1000);
    });

    function printCodes() {
      const printWindow = window.open('', '_blank');
      const styles = `
        <style>
          body { font-family: 'VT323', monospace; text-align: center; padding: 20px; }
          h2 { margin-bottom: 20px; }
          ul { list-style: none; padding: 0; }
          li {
            margin: 10px 0;
            font-size: 24px;
            border: 1px dashed #444;
            padding: 10px;
            width: 200px;
            margin-left: auto;
            margin-right: auto;
          }
        </style>`;
      const codesHtml = validCodes.map(code => `<li>${code}</li>`).join('');
      printWindow.document.write(`<html><head>${styles}</head><body><h2>Access Codes</h2><ul>${codesHtml}</ul></body></html>`);
      printWindow.document.close();
      printWindow.print();
    }
  </script>
</body>
</html>
