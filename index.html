<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Receipt Photobooth</title>

  <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Libre+Barcode+128+Text&display=swap" rel="stylesheet" />

  <style>
    /* Basic page styling */
    body {
      margin: 0;
      font-family: 'VT323', monospace;
      background: #f0f0f0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }

    /* Barcode-like header styling */
    .title-barcode {
      font-family: 'Libre Barcode 128 Text', cursive;
      font-size: 60px;
      margin-top: 20px;
    }

    /* Layout for the camera and previews */
    .photobooth-container {
      display: flex;
      gap: 20px;
      align-items: flex-start;
      margin-top: 20px;
    }

    .column {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    /* Video feed style */
    video {
      width: 960px;
      height: 720px;
      border: 3px solid white;
    }

    /* Styles for individual photo previews */
    .photo {
      width: 240px;
    }

    .strip-photo {
      width: 240px;
      border: 1px solid #ccc;
      margin: 5px 0;
    }

    /* Container for final photo strip 
    #photo-strip {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 1rem;
      background: black;
      padding: 10px;
      width: 300px;
      border: 2px solid #999;
    }*/

    #photostrip {
      display: none;
      align-items: center;
      margin-left: 1rem;
      background: white;
      padding: 10px;
      height: 180px;
      border: 2px solid #999;
    }

    /* Button styling */
    button {
      padding: 10px 20px;
      margin: 10px 5px;
      font-size: 1rem;
      border: none;
      border-radius: 6px;
      background-color: #3f51b5;
      color: white;
      cursor: pointer;
    }

    button:hover {
      background-color: #303f9f;
    }

    /* Hidden dev-only button */
    #hidden-button {
      position: absolute;
      bottom: 10px;
      left: 10px;
      width: 50px;
      height: 50px;
      z-index: 1000;
      opacity: 0;
      background: transparent;
      border: none;
    }

    /* Code input modal popup */
    #codeInputPopup {
      position: absolute;
      top: 30%;
      left: 50%;
      transform: translateX(-50%);
      background: #222;
      padding: 20px;
      border-radius: 10px;
      display: none;
      color: white;
    }

    /* Countdown text styling */
    #countdown {
      font-size: 30px;
      color: #333;
    }

    /* Photo select hover and active style */
    .selectable {
      cursor: pointer;
      transition: transform 0.2s, border 0.2s;
    }

    .selectable:hover {
      transform: scale(1.05);
    }

    .selected {
      border: 3px solid #4caf50;
    }

    #selection-instructions {
      font-size: 20px;
      margin-top: 1rem;
      color: #555;
    }

    #finalizeBtn {
      display: none;
      background-color: #4caf50;
    }

    #resetBtn {
      display: none;
      background-color: #4caf50;
    }

    #printBtn {
      display: none;
      background-color: #4caf50;
    }
  </style>
</head>
<body>
  <!-- Barcode-style title -->
  <h1 class="title-barcode">Receipt Photobooth</h1>

  <!-- Countdown timer display -->
  <div id="countdown">Print Now</div>

  <!-- Camera & preview area -->
  <div class="photobooth-container" id="cameraSection">
    <!-- Left column of captured photos -->
    <div class="column">
      <img class="photo" id="shot1" />
      <img class="photo" id="shot2" />
      <img class="photo" id="shot3" />
    </div>

    <!-- Live webcam video -->
    <video id="video" autoplay></video>

    <!-- Right column of captured photos -->
    <div class="column">
      <img class="photo" id="shot4" />
      <img class="photo" id="shot5" />
      <img class="photo" id="shot6" />
    </div>
  </div>

  <!-- Controls: Start, Print -->
  <div>
    <button id="startBtn">üì∏ Print Receipt</button>
    
  </div>

  <!-- Photo selection instructions -->
  <div id="selection-instructions"></div>
  <button onclick="printPhoto()" id="printBtn">üñ®Ô∏è Print</button>
  <!-- Output strip for selected photos -->
  <div id="photostrip"></div>
  <button id="finalizeBtn">‚úÖ Finalize Strip</button>


  <!-- Hidden developer tool for testing codes -->
  <button id="hidden-button" onclick="printCodes()">Print Codes</button>

  <!-- Popup for entering secret code to begin -->
  <div id="codeInputPopup">
    <label for="codeInput">Enter Code to Start:</label><br/>
    <input type="text" id="codeInput" placeholder="Enter code" /><br/><br/>
    <button id="confirmBtn">Confirm</button>
  </div>

  <script>
    // Grab key DOM elements
    const video = document.getElementById('video');
    const photoStrip = document.getElementById('photostrip');
    const codePopup = document.getElementById('codeInputPopup');
    const codeInput = document.getElementById('codeInput');
    const startBtn = document.getElementById('startBtn');
    const confirmBtn = document.getElementById('confirmBtn');
    const countdown = document.getElementById('countdown');
    const cameraSection = document.getElementById('cameraSection');

    // Canvas for snapshot capture
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');

    // DOM references for each photo slot
    const shots = Array.from({ length: 6 }, (_, i) => document.getElementById(`shot${i + 1}`));

    // Allowed access codes
    const validCodes = ['PRINS', 'TIMS'];

    // State variables
    let currentShot = 0;
    let capturedPhotos = [];
    let selectedPhotos = [];

    // Add random access codes for dev use
    while (validCodes.length < 20) {
      validCodes.push(Math.random().toString(36).substring(2, 8).toUpperCase());
    }

    // Show code input popup
    startBtn.addEventListener('click', () => {
      codePopup.style.display = 'block';
    });

    // Validate access code and begin
    confirmBtn.addEventListener('click', async () => {
      const input = codeInput.value.trim().toUpperCase();
      if (validCodes.includes(input)) {
        codePopup.style.display = 'none';
        cameraSection.style.display = 'flex';
        startPhotoSequence();
      } else {
        alert('Invalid Code!');
      }
    });

    // Start webcam on page load
    window.onload = async function initCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
      } catch (err) {
        alert('Camera not accessible: ' + err.message);
      }
    };

    // Take 6 photos on a 2-second timer
    function startPhotoSequence() {
      document.getElementById('startBtn').style.display = 'none';
      currentShot = 0;
      capturedPhotos = [];
      let timer = 2;

      const interval = setInterval(() => {
        countdown.textContent = `Timer: ${timer}s | Shot: ${currentShot + 1}/6`;
        if (timer === 0) {
          takePhoto();
          currentShot++;
          timer = 2;
        } else {
          timer--;
        }

        if (currentShot >= 6) {
          clearInterval(interval);
          endPhotoSession();
        }
      }, 1000);
    }

    // Capture current frame from webcam
    function takePhoto() {

      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const dataUrl = canvas.toDataURL('image/png');

      // Preview photo
      if (shots[currentShot]) {
        shots[currentShot].src = dataUrl;
      }

      // Save copy for selection
      const img = new Image();
      img.src = dataUrl;
      capturedPhotos.push(img);
    }

    // End session and show photo selection
    function endPhotoSession() {
      countdown.textContent = 'Click to select your 4 favorite photos';
      const tracks = video.srcObject?.getTracks();
      if (tracks) tracks.forEach(track => track.stop());

      cameraSection.style.display = 'none';
      photoStrip.style.display = 'flex';
      photoStrip.innerHTML = '';
      selectedPhotos = [];

      // Add clickable preview images
      capturedPhotos.forEach((photo) => {
        const clone = photo.cloneNode();
        clone.classList.add('strip-photo', 'selectable');
        clone.addEventListener('click', () => toggleSelectPhoto(clone));
        photoStrip.appendChild(clone);
      });

      document.getElementById('selection-instructions').style.display = 'block';
      document.getElementById('finalizeBtn').style.display = 'inline-block';
      document.getElementById('resetBtn').style.display = 'inline-block';
    }

    // Toggle photo selection
    function toggleSelectPhoto(photo) {
      if (selectedPhotos.includes(photo)) {
        selectedPhotos = selectedPhotos.filter(p => p !== photo);
        photo.classList.remove('selected');
      } else {
        if (selectedPhotos.length >= 4) {
          alert('You can only select 4 photos.');
          return;
        }
        selectedPhotos.push(photo);
        photo.classList.add('selected');
      }
    }

    // Finalize selection and show printable strip
    document.getElementById('finalizeBtn').addEventListener('click', () => {
      if (selectedPhotos.length !== 4) {
        alert('Please select exactly 4 photos.');
        return;
      }

      countdown.textContent = 'Print your Receipt';
      photoStrip.innerHTML = '';
      photoStrip.style.display = 'flex';
      photoStrip.style.flexDirection = 'column';
      photoStrip.style.width = '240px';
      photoStrip.style.height = '800px';
      selectedPhotos.forEach(photo => {
        const clone = photo.cloneNode();
        clone.classList.remove('selectable', 'selected');
        clone.classList.add('strip-photo');
        photoStrip.appendChild(clone);
      });

      document.getElementById('selection-instructions').style.display = 'none';
      document.getElementById('finalizeBtn').style.display = 'none';
      document.getElementById('printBtn').style.display = 'inline-block';
    });

    // Developer: print all valid codes
    function printCodes() {
      const printWindow = window.open('', '_blank');
      const styles = `
        <style>
          body { font-family: monospace; text-align: center; padding: 20px; }
          ul { list-style: none; padding: 0; }
          li {
            margin: 10px 0;
            font-size: 24px;
            border: 1px dashed #444;
            padding: 10px;
            width: 200px;
            margin: 0 auto;
          }
        </style>`;
      const codesHtml = validCodes.map(code => `<li>${code}</li>`).join('');
      printWindow.document.write(`<html><head>${styles}</head><body><h2>Access Codes</h2><ul>${codesHtml}</ul></body></html>`);
      printWindow.document.close();
      printWindow.print();
    }

    // Print selected photos as a receipt
    function printPhoto() {
      const printWindow = window.open('', '_blank');
      const style = `
        <style>
          body { text-align: center; font-family: sans-serif; }
          img { width: 240px; margin: 10px auto; display: block; background: black; border: 1px solid #ccc; }
        </style>`;
      const images = Array.from(photoStrip.querySelectorAll('img'))
        .map(img => `<img src="${img.src}" />`)
        .join('');
      printWindow.document.write(`<html><head>${style}</head><body>${images}</body></html>`);
      printWindow.document.close();
      printWindow.focus();
      printWindow.print();
      
      setTimeout(() => {
        location.reload();
      }, 1000); // 3 seconds ‚Äî adjust based on expected print time
    }

    resetToStart = () => {
      // Reset everything to initial state
      shots.forEach(shot => shot.src = '');
      photoStrip.innerHTML = '';
      photoStrip.style.display = 'none';
      selectedPhotos = [];
      currentShot = 0;
      document.getElementById('startBtn').style.display = 'inline-block';
      document.getElementById('cameraSection').style.display = 'flex';
      document.getElementById('selection-instructions').style.display = 'none';
      document.getElementById('finalizeBtn').style.display = 'none';
      document.getElementById('printBtn').style.display = 'none';
      photoStrip.style.flexDirection = 'row';
      photoStrip.style.width = 'auto';
      photoStrip.style.height = '180px';
      countdown.textContent = 'Print Now';

      // Re-access the camera
  startCamera(); // ‚úÖ Make sure this function exists
    };

    function startCamera() {
      navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
          const video = document.getElementById('video');
          video.srcObject = stream;
          video.play();
        })
        .catch(err => {
          console.error("Error accessing camera: ", err);
          alert("Cannot access camera. Please allow permission.");
        });
    }

  </script>
</body>
</html>
